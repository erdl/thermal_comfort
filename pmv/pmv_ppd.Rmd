---
title: "Building + Room All in One PMV PPD"
author: "Carlos V. Paradis"
date: "October 15, 2018"
output: 
  html_document:
    number_sections: true
    toc: true
    fig_width: 7
    fig_height: 4.5
    theme: cosmo
    highlight: tango
    code_folding: hide
---

```{r,warning=FALSE,message=FALSE}
s <- suppressPackageStartupMessages
s(library(data.table))
s(library(lubridate))
s(library(knitr))
s(library(dygraphs))
s(library(ggplot2))
s(library(gridExtra))
s(library(grid))
```


# Introduction

This R Notebook utilizes the javascript functions from the [CBE Comfort Tool](http://comfort.cbe.berkeley.edu/), freely available on the website's [Github](https://github.com/CenterForTheBuiltEnvironment/comfort_tool/tree/master/static/js) in order to estimate the thermal comfort of the students of FROG UHM.

# How to Use

   * Use the code block "Monitored" or "Simulation" to load the associated data and put it in a common format for the rest of the notebook. (Remember to set the unused code block as eval = FALSE and the other with eval = TRUE).
   * Change the title of the plot on the **data_type** variable
   * Change the location of the file from c_view_house_<number> provided by Eileen on the **readings** variable
   * Change the **fpm** variable for the air speed velocity (e.g. 0, 120, 200).
   * Change the **save_file_path_name** variable with the location and file name.csv you want to save the generated plot.
   * Current code does not apply any filter to what months to keep. Just the adaptive method code.

If you need the table so it can be plotted in Tableau, you can use **pmv_elevated_air** data frame variable and save it to a .csv. 

That's all! Once the pipeline and plots get more stable, I will code a script out of this.

# Readings

The readings are from house 3, living room. The following code block prepares the input table averaging hourly:

```{r Monitored, eval = TRUE}
data_type = "Monitored House 2 Living Room"

#readings <- fread("~/Github/erdl/thermal_comfort/pmv/data/monitored/house8/house8_livingroom_pmv.csv")
#readings <- fread("~/Github/erdl/thermal_comfort/adaptive_method/data/monitored/house2/c_view_house_2_adaptive_living_room.csv")
readings <- fread("~/Downloads/all_rooms_temp_humdity_hrly.csv")
readings <- readings[complete.cases(readings)]
#colnames(readings) <- c("timestamp","building_id","ta","rh")
colnames(readings) <- c("building_id","room","timestamp","ta","rh")
readings$timestamp <- ymd_hms(readings$timestamp)
readings$ta <- as.numeric(readings$ta)
readings$rh <- as.numeric(readings$rh)

#Reset the minute and second to 0, so we can group by ymd_h. 
minute(readings$timestamp) <- 0
second(readings$timestamp) <- 0
readings_complete <- readings[,.(ta=mean(ta),rh=mean(rh)),by=c("timestamp","building_id","room")]
readings <- readings_complete[,.(timestamp,ta,rh)]
```

```{r Simulated, warning = FALSE,eval=FALSE}
data_type = "Simulated House 8 Run 0"
readings <- fread("~/Github/erdl/thermal_comfort/pmv/data/simulated/house-8-run-0.csv")
colnames(readings) <- sapply(str_split(colnames(readings)," - "),"[[",2)
readings <- readings[2:.N,.(ta=as.numeric(`Living Space|Indoor Temperature`), #First row is units
            rh=as.numeric(`Living Space|Indoor Relative Humidity`))]
timestamp <- ymd_hms("1800-01-01 00:00:00") + hours(1:nrow(readings))

```


## Used Variables

Of the provided data, the following variables were used:

 * Air Temperature
 * Mean Radiant Temperature
 * Relative Air Velocity 
 * Relative Humidity 
 
In addition, the following artificially created variables were used:

 * Metabolic Rate = 1.0
 * Clothing Level = 0.45
 * External Work = 0 (According to the CBE Comfort Tool Documentation)

```{r}
# params
fpm <- 0
save_file_path_name <- paste0("~/Desktop/house_test_run_0_fpm_",fpm,".png")


# Add artificial values
readings$tr <- readings$ta
readings$vel <- fpm
readings$met <- 1.0
readings$clo <- 0.45
readings$wme <- 0
readings <- readings[,.(ta,tr,vel,rh,met,clo,wme,timestamp)]

```

# Conversions

For the CBE Comfort Tool, the following units must be respected for the variables:

 * Air Temperature, Mean Radiant Temperature = C
 * Relative Air Velocity = m/s
 * Relative Humidity = %
 
And were converted from the sample data to meet the expected units.

```{r}
readings_si <- readings
#Convert F to C
readings_si$ta <- (readings$ta - 32)*(5/9)
readings_si$tr <- (readings$tr - 32)*(5/9)

# Convert fpm to m/s
readings_si$vel <- 0.00508 * readings$vel
```


# Elevated Air Speed PMV Model

This notebook uses the javascript function from the CBE Comfort Tool by passing the sample data after preparation as input, and then retrieving the output of the function which contains the PMV and PPD. 

```{r Javascript Version,warning=FALSE,message=FALSE, include=FALSE, cache=FALSE}
sink("/dev/null") # omit print messages generated by v8
#Load Google's Javscript Engine V8 (See https://cran.r-project.org/web/packages/V8/vignettes/v8_intro.html)
library(V8)
#Create a new context
ct <- v8()

#Load Javascript Library for forEach function
ct$source(system.file("js/underscore.js", package="V8"))
#Load local comfortModel javscript library (only modified the path of the libraries)
ct$source("comfortmodels.js")
ct$source("util.js")
ct$source("psychrometrics.js")

#Apply the function over all the table for pmvElevatedAirspeed
    # returns [pmv, ppd]
    # ta, air temperature (C)
    # tr, mean radiant temperature (C)
    # vel, relative air velocity (m/s)
    # rh, relative humidity (%) Used only this way to input humidity level
    # met, metabolic rate (met)
    # clo, clothing (clo)
    # wme, external work, normally around 0 (met)
pmv_elevated_air <- data.table(ct$call("_.map", readings_si, JS("function(x){return(comf.pmvElevatedAirspeed(x.ta,x.tr,x.vel,x.rh,x.met,x.clo,x.wme))}")))
sink()
```

# Merge Results with Timestamps and Readings

After the model results is output, the data is combined with the original readings for comparison.

```{r}
pmv_elevated_air <- cbind(readings,pmv_elevated_air)
```

# PMV Results

In addition to PMV and PPD, the following columns are also output in the table (not shown below):

 * SET
 * TA_adj
 * TR_adj
 * cooling_effect
 
 The first 3 columns relate to the `Elevated Airspeed` adjustmenet to the PMV model, which can't handle high air speeds in the original proposal by Fanger. 

## Output Table

First few rows of the table for Frogs 1. 

```{r}
# Convert ta to tr 
pmv_elevated_air$ta_adj <- pmv_elevated_air$ta_adj*1.8 + 32
pmv_elevated_air$tr_adj <- pmv_elevated_air$tr_adj*1.8 + 32

# Add Building ID and Room from the original table 

pmv_elevated_air <- cbind(pmv_elevated_air,readings_complete[,.(building_id,room)])

kable(head(pmv_elevated_air))
```

# Plot

```{r}
pmv_elevated_air$thermal_sensation <- NA_character_
pmv_elevated_air[pmv > 0.5]$thermal_sensation <- "Unacceptable Hot"
pmv_elevated_air[pmv >= -0.5 & pmv <= 0.5]$thermal_sensation <- "Acceptable"
pmv_elevated_air[pmv < -0.5]$thermal_sensation <- "Unacceptable Cold"

n_acceptable <- nrow(pmv_elevated_air[thermal_sensation == "Acceptable"])
n_unacceptable <- nrow(pmv_elevated_air[thermal_sensation != "Acceptable"])

percent <- function(x, digits = 2, format = "f", ...) {
  paste0(formatC(100 * x, format = format, digits = digits, ...), "%")
}

n_acceptable_percent <- percent(n_acceptable/(n_acceptable+n_unacceptable))
n_unacceptable_percent <- percent(n_unacceptable/(n_acceptable+n_unacceptable))

st <- min(pmv_elevated_air$timestamp)
et <- max(pmv_elevated_air$timestamp)
p_start_time <- paste0(year(st),"-",month(st),"-",day(st))
p_end_time <- paste0(year(et),"-",month(et),"-",day(et))



status <- paste0(p_start_time," to ",p_end_time," | Acceptable: ",n_acceptable," (",n_acceptable_percent,") ; Unacceptable: ",n_unacceptable," (",n_unacceptable_percent,")")
```

```{r}
p <- ggplot(data = pmv_elevated_air) + 
  geom_point(aes(ta,rh,color=thermal_sensation)) + 
  theme_minimal() + 
  xlab("Temperature (F)") + 
  ylab("Relative Humidity (%)") + 
  scale_colour_manual(values=c("Unacceptable Cold"="#0072B2","Acceptable"="#009E73","Unacceptable Hot"="#D55E00"))  + 
  labs(color="Thermal Sensation")
```


```{r}
q <- ggplot(data = pmv_elevated_air) +
  aes(pmv,fill=thermal_sensation) +
  geom_histogram(binwidth = 0.5, col="grey",boundary = 0) +
  scale_x_continuous(breaks = seq(-5,5,0.5), lim = c(-5,5)) + theme_minimal() + 
  xlab("PMV") + 
  ylab("Number of Hours") + 
  scale_fill_manual(values=c("Unacceptable Cold"="#0072B2","Acceptable"="#009E73","Unacceptable Hot"="#D55E00")) + 
  labs(fill="Thermal Sensation")
```


```{r fig.width= 9, fig.height=4}
tg <- textGrob(paste0("PMV - ",data_type," Fpm ",fpm), gp=gpar(fontsize=15))
sg <- textGrob(status, gp=gpar(fontsize=10))
margin <- unit(0.5, "line")
grid.arrange(tg, sg, arrangeGrob(p,q,ncol = 2),
             heights = unit.c(grobHeight(tg) + 1.2*margin, 
                              grobHeight(sg) + margin, 
                              unit(1,"null")))
```


```{r}
# 28.34 is pixel to cm, see: http://www.answers.com/Q/How_many_pixels_to_one_centimeter
ggsave(filename=save_file_path_name,
       plot=grid.arrange(tg, sg, arrangeGrob(p,q,ncol = 2),
             heights = unit.c(grobHeight(tg) + 1.2*margin, 
                              grobHeight(sg) + margin, 
                              unit(1,"null"))),
     width=1340/(28.34*3),
     height=585/(28.34*3))
```

